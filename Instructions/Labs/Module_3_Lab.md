---
lab:
    title: '3: Azure Migrate を使用して Hyper-V VM を Azure に移行する'
    module: 'モジュール 3: データ移行の設計'
---

# ラボ: Azure Migrate を使用して Hyper-V VM を Azure に移行する
# 受講生用ラボ マニュアル

## ラボ シナリオ

Azure への移行の一部としてワークロードを最新化するという野心にもかかわらず、Adatum Enterprise Architecture チームは、積極的なタイムラインのため、多くの場合、リフトアンドシフトのアプローチに従う必要があることを認識しています。このタスクを簡略化するために、Adatum Enterprise Architecture チームは Azure Migrate の機能の調査を開始しました。Azure Migrate は、Azure オンプレミス サーバー、インフラストラクチャ、アプリケーション、およびデータを評価して移行するための集中ハブとして機能します。

Azure Migrate には次の機能が用意されています。

- 統合された移行プラットフォーム: Azure への移行を開始、実行、追跡するための単一のポータル。
- ツールの範囲: 評価と移行のためのさまざまなツール。ツールには、Azure Migrate: Server Assessment、Azure Migrate: Server Migration に関するエラーのトラブルシューティングに役立つ情報を提供しています。Azure Migrate は、他の Azure サービスや、他のツールおよび独立系ソフトウェア ベンダー (ISV) オファリングと統合されています。
- 評価と移行: Azure Migrate ハブでは、以下の評価と移行を行うことができます。
- サーバー: オンプレミスのサーバーを評価し、Azure の仮想マシンに移行します。
- データベース: オンプレミスのデータベースを評価し、Azure SQL Database または SQL Managed Instance に移行します。
- Web アプリケーション: Azure App Service Migration Assistant を使用して、オンプレミスの Web アプリケーションを評価し、Azure App Service に移行します。
- 仮想デスクトップ: オンプレミスの仮想デスクトップ インフラストラクチャ (VDI) を評価し、Azure の Windows Virtual Desktop に移行します。
- データ:Azure Data Box 製品を使用して、大量のデータを迅速かつコスト効果よく Azure に移行します。

データベース、Web アプリ、仮想デスクトップは移行イニシアチブの次の段階の範囲にありますが、Adatum Enterprise Architecture チームは、オンプレミスの Hyper-V 仮想マシンを Azure VM に移行するための Azure Migrate の使用を評価することから始めたいと考えています。

## 目標
  
このラボを完了すると、次のことができるようになります。

-  Azure Migrate を使用して、評価と移行のために Hyper-V を準備する

-  Azure Migrate を使用して移行のために Hyper-V を評価する

-  Azure Migrate を使用して Hyper-V VM を移行する


## ラボ環境
  
Windows Server 管理者の資格情報

-  User Name (ユーザー名): **Student**

-  パスワード: **Pa55w.rd1234**

推定時間: 120 分


## ラボ ファイル

-  \\\\AZ304\\AllFiles\\Labs\\08\\azuredeploy30308suba.json


### 演習 0: ラボ環境の準備

この演習の主なタスクは次のとおりです。

1. Azure Resource Manager クイックスタート テンプレートを使用して Azure VM をデプロイする

1. Azure VM でネストされた仮想化を構成する


#### タスク 1: Azure Resource Manager クイックスタート テンプレートを使用して Azure VM をデプロイする

1. ラボのコンピューターから Web ブラウザーを起動し、[Azure portal](https://portal.azure.com) - `portal.azure.com` に移動して、このラボで使用するサブスクリプションの所有者の役割を持つユーザー アカウントの認証情報を提供してサインインします。

1. Azure で、検索テキストボックスのすぐ右にあるツールバーアイコンを選択して、**Cloud Shell** ペインを表示します。

1. **Bash** や **PowerShell** のどちらかを選択するためのプロンプトが表示されたら、**PowerShell** を選択します。 

   > **注**: **Cloud Shell** を初めて起動し、「**ストレージがマウントされていません**」というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、「**ストレージの作成**」を選択します。 

1. Cloud Shell ペインのツールバーで、 **ファイルのアップロード/ダウンロード** アイコンを選択し、ドロップダウン メニューで **アップロード**を選択して、ファイル  **\\\\\AZ303\\AllFiles\Labs\\08\\azuredeploy30308suba.json** を Cloud Shell ホーム ディレクトリにアップロードします。

1. Cloud Shell から次のコマンドを実行して最寄りの Azure リージョンのある場所の名前が付いた変数を設定します (`<Azure region>` プレースホルダーを、サブスクリプションでの Azure VM のデプロイに使用でき、ラボのコンピューターの場所に最も近い Azure リージョンの名前に置き換えます。例: 'eastus'):

   ```powershell
   $location = '<Azure region>'
   ```

      > **注記**: Azure VM をプロビジョニングできる Azure リージョンを識別するには、[**https://azure.microsoft.com/ja-jp/regions/offers/**](https://azure.microsoft.com/ja-jp/regions/offers/) を参照してください。
      
1. Cloud Shell ペインで次の操作を実行してリソース グループを作成します:

   ```powershell
   New-AzSubscriptionDeployment `
     -Location $location `
     -Name az30308subaDeployment `
     -TemplateFile $HOME/azuredeploy30308suba.json `
     -rgLocation $location `
     -rgName 'az30308a-labRG'
   ```

1. Azure portal で、**Cloud Shell** ウィンドウを閉じます。

1. ラボ コンピューターから別のブラウザー タブを開き、[301-nested-vms-in-virtual-network Azure クイックスタート テンプレート](https://github.com/Azure/azure-quickstart-templates/tree/master/demos/nested-vms-in-virtual-network) に移動して、「**Azure にデプロイする**」 を選択します。これにより、ブラウザーは自動的に Azure portal の**入れ子になった VM を持つ Hyper-V ホスト仮想マシン** ブレードにリダイレクトされます。

    ``` url
    https://github.com/Azure/azure-quickstart-templates/tree/master/demos/nested-vms-in-virtual-network
    ```

1. Azure portal の**入れ子になった VM を持つ Hyper-V ホスト仮想マシン** ブレードで、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az30308a-labRG** |
    | ホスト パブリック IP アドレス名 | **az30308a-hv-vm-pip** |
    | 仮想ネットワーク名 | **az30308a-hv-vnet** |
    | ホスト ネットワークのインターフェイス 1 の名前 | **az30308a-hv-vm-nic1** |
    | ホスト ネットワークのインターフェイス 2 の名前 | **az30308a-hv-vm-nic2** |
    | ホスト仮想マシン名 | **az30308a-hv-vm** |
    | ホスト管理者のユーザー名 | **Student** |
    | ホスト管理者のパスワード | **Pa55w.rd1234** |

1. 「**Hyper-V Host Virtual Machine with nested VMs (入れ子になった VM による仮想マシンでの Hyper-V)**」ブレードで、「**レビュー + 作成**」を選択し、「**作成**」を選択します。

    > **注**: デプロイが完了するのを待ちます。デプロイには約 10 分間かかります。

#### タスク 2: Azure VM でネストされた仮想化を構成する

1. Azure portal で、**仮想マシン**を検索して選択し、**仮想マシン** ブレードで **az30308a-hv-vm** を選択します。

1. **az30308a-hv-vm** ブレードで、「**ネットワーク**」 を選択します。 

1. **az30308a-hv-vm** で **| ネットワーク** ブレードで、**az30308a-hv-vm-nic1** タブを選択し、次に 「**受信ポート規則を追加する**」 を選択してください。

    > **注**: 必ず、パブリック IP アドレスが割り当てられている **az30308a-hv-vm-nic1** の設定を変更してください。

1. 「**受信セキュリティ規則の追加**」 ブレードで、次の設定を指定し (他は既定値のままにします)、「**追加**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | Destination port range | **3389** |
    | プロトコル | **Any** |
    | 名前 | **AllowRDPInBound** |

1. 「**az30308a-hv-vm**」 ブレードで、「**概要**」 を選択します。 

1. 「**az30308a-hv-vm**」 ブレードで、ドロップダウン メニューから 「**接続**」、「**RDP**」 を選択し、「**RDP ファイルのダウンロード**」 をクリックします。

1. プロンプトが表示されたら、「**接続**」 をクリックし、以下の認証情報を使用してサインインします。

    | 設定 | 値 | 
    | --- | --- |
    | 「ユーザー名」 | **Student** |
    | パスワード | **Pa55w.rd1234** |

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、「サーバー マネージャー」 ウィンドウの 「**ローカル サーバー**」 をクリックし、「**IE セキュリティ強化の構成**」 ラベルの横にある 「**オン**」 リンクをクリックし、「**IE セキュリティ強化の構成**」 ダイアログ ボックスで両方の 「**オフ**」 オプションを選択した後、「**OK**」 をクリックします 。

1. リモート デスクトップ セッションからエクスプローラーを開き、**F:** に移動します。**VHDs** という名前のフォルダーを作成します。

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、Internet Explorer を起動し、[Microsoft Edge](https://www.microsoft.com/ja-jp/edge/business/download) のダウンロード ページに移動し、Microsoft Edge インストーラーをダウンロードして、インストールを実行します。 

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、Microsoft Edge を起動し、[Windows サーバーの評価](https://www.microsoft.com/ja-jp/evalcenter/evaluate-windows-server-2019) を参照して、Windows Server 2019 **VHD** ファイルを **F:\VHDs** フォルダーにダウンロードします。 
    
    ```url
    https://www.microsoft.com/ja-jp/evalcenter/evaluate-windows-server-2019
    ```
    
    > **注**: 評価ページでは、ダウンロードを完了するために個人情報を尋ねられます。「英国」 または他の国を選択すると、通知をオプトアウトできます。

1. **Az30308a-hv-vm** へのリモート デスクトップ セッション内で 「スタート」 をクリックし、「**Windows 管理ツール**」 をクリックして **Hyper-V マネージャー**を起動します。 

1. **Hyper-V マネージャー** コンソールで、「**az30308a-hv-vm**」 ノードを選択します。 

1. 「**新規作成**」 をクリックし、カスケード メニューで 「**仮想マシン**」 をクリックします。これにより、**新しい仮想マシン ウィザード**が起動します。 

1. 「**新しい仮想マシン ウィザード**」 の 「**開始する前に**」 ページで、「**次へ >**」 を選択します。

1. 「**新しい仮想マシン ウィザード**」 の 「**名前と場所を指定する**」 ページで、次の設定を指定し、「**次へ >**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | 名前 | **az30308a-vm1** | 
    | 仮想マシンを別の場所に保存する | 選択済み | 
    | 場所 | **F:\VMs** |

    > **注**: 必ず **F:\VMs** フォルダーを作成してください。

1. 「**新しい仮想マシン ウィザード**」 の 「**世代を指定**」 ページで、「**世代 1**」 オプションが選択されていることを確認し、「**次へ >**」 を選択します:

1. 「**新しい仮想マシン ウィザード**」 の 「**メモリの割り当て**」 ページで、「**起動メモリ**」 を 「**2048**」 に設定し、「**次へ >**」 を選択します。

1. 「**新しい仮想マシン ウィザード**」 の 「**ネットワークを構成する**」 ページの 「**接続**」 ドロップダウン リストで、**NestedSwitch** を選択し、 「**次へ >**」 を選択します。

1. 「**新しい仮想マシン ウィザード**」 の 「**仮想ハード ディスクを接続する**」 ページで、オプション 「**既存の仮想ハード ディスクを使用する**」 を選択し、場所を **F:\VHDs** フォルダーにダウンロードした VHD ファイルに設定し、「**次へ >**」 を選択します。

1. 「**新しい仮想マシンウィザード**」 の 「**概要**」 ページで、「**仕上げ**」 を選択します。

1. **Hyper-V マネージャー** コンソールで、新しく作成した仮想マシンを選択し、「**開始**」 を選択します。 

1. **Hyper-V マネージャー** コンソールで、仮想マシンが実行されていることを確認し、「**接続**」 を選択します。 

1. 「**az30308a-vm1** への仮想マシン接続」 ウィンドウの 「**こんにちは**」 ページで、「**次へ**」 を選択します。 

1. 「**az30308a-vm1** への仮想マシン接続」 ウィンドウの 「**ライセンス条項**」 ページで、「**承諾**」 を選択します。 

1. 「**az30308a-vm1** への仮想マシン接続」 ウィンドウの 「**設定をカスタマイズする**」 ページで、組み込みの管理者アカウントのパスワードを **Pa55w.rd1234** に設定し、「**終了**」 を選択します。 

1. 「**az30308a-vm1** への仮想マシン接続」 ウィンドウで、新しく設定したパスワードを使用してサインインします。

1. 「**az30308a-vm1** への仮想マシン接続」 ウィンドウで、Windows PowerShell を起動し、**管理者:** で**Windows PowerShell** ウィンドウで次を実行して、コンピューター名を設定します。 

   ```powershell
   Rename-Computer -NewName 'az30308a-vm1' -Restart
   ```

### 演習 1: Azure Migrate を使用した評価と移行の準備
  
この演習の主なタスクは次のとおりです。

1. Hyper-V 環境を構成する

1. Azure Migrate プロジェクトの作成

1. ターゲットの Azure 環境を実装する


#### タスク 1: Hyper-V 環境を構成する

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で Microsoft Edge を起動し、[[Microsoft ダウンロード センター](https://aka.ms/migrate/script/hyperv)] に移動して、構成 PowerShell スクリプトを **F:** にダウンロードします。

    ```url
    https://aka.ms/migrate/script/hyperv
    ```

    >**注**: このスクリプトは、次を実行します。

    - サポートされている PowerShell バージョンでスクリプトが実行されていることを確認します。

    - Hyper-V ホストに対する管理者権限があることを確認します。

    - Azure Migrate サービスが Hyper-V ホストとの通信に使用するローカル ユーザー アカウントを作成できます。このユーザー アカウントは、Hyper-V ホストの リモート管理ユーザー、 Hyper-V Administrators、および パフォーマンス モニターユーザー グループに追加されます。

    - サポートされているバージョンの Hyper-V がホストで実行されていることを確認し、Hyper-V ロールを確認します。

    - WinRM サービスを有効にし、ホストのポート 5985（HTTP）および 5986（HTTPS）を開きます。これはメタデータ収集に必要です。

    - ホストでの PowerShell リモート処理を有効にします。

    - ホストによって管理されているすべての VM で Hyper-V 統合サービスが有効になっていることを確認します。

    - 必要に応じて、ホスト上で CredSSP を有効にします。

1. **az30308a-hv-vm** へのリモートデスクトップセッション内で **Windows PowerShell ISE** を起動します。 

1. 「**管理者: Windows PowerShell ISE** ウィンドウのコンソール ペインで次のコマンドを実行して、Zone.Identifier 代替データ ストリームを削除します。この場合、ファイルがインターネットからダウンロードされたことを示しています。

   ```powershell
   Unblock-File -Path F:\MicrosoftAzureMigrate-Hyper-V.ps1
   ```

1. 「**管理者: Windows PowerShell ISE** ウィンドウで、**F:** フォルダーにある **MicrosoftAzureMigrate-Hyper-V.ps1** スクリプトを開いて実行します。確認を求められたら、**Y** キーを押してから**Enter** キーを押します。ただし、次のプロンプトは例外であり、その場合は **N** をタイプし、 **Enter** キーを押します。

- SMB 共有を使用して VHD を保存していますか？

- Azure Migrate と Hyper-V ホスト通信用の非管理者ローカルユーザーを作成しますか? 


#### タスク 2: Azure Migrate プロジェクトの作成

1. **az30308a-hv-vm** へのリモートデスクトップセッション内で、Microsoft Edge を起動し、 [Azure portal](https://portal.azure.com) に移動し、このラボで使用するサブスクリプションの所有者の役割を持つユーザー アカウントの認証情報を提供してサインインします。

1. Azure portal で「**Azure Migrate**」を検索して選択し、「**Azure Migrate**」 ブレードの 「**移行の目標**」 セクションで、「**サーバー**」 を選択してから 「**プロジェクトの作成**」 を選択します。

1. 「**Azure Migrate**」 ブレードで、次の設定を指定し (他は既定値のままにします)、「**作成**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az30308b-LabRG** の名前 |
    | プロジェクトを移行する | **az30308b-migrate-project** |
    | Geography | あなたの国または地域の名前 |


#### タスク 3: ターゲットの Azure 環境を実装する

1. Azure portal で、**仮想ネットワーク**を検索して選択し、「**仮想ネットワーク**」 ブレードで、「**+ 新規**」 を選択します。

1. 「**仮想ネットワークの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定し (他は既定値のままにします)、「**次へ: IP アドレス**:

    | 設定 | 値 |
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | 新しいリソース グループ **az30308c-LabRG** の名前 |
    | 名前 | **az30308c-migration-vnet** |
    | リージョン | このラボの前半で仮想マシンにデプロイした Azure リージョンの名前 |

1. 「**仮想ネットワークを作成する**」 ブレードの 「**IP アドレス**」 タブで、「**IPv4 アドレス空間**」 テキスト ボックスに「**10.8.0.0/16**」と入力し、「**+ サブネットを追加**」 を選択します。

1. **サブネットを追加** ブレードで次の設定を指定（他の設定はデフォルト値のままにします）し、 **追加**を選択します：

    | 設定 | 値 |
    | --- | --- |
    | サブネット名 | **subnet0** |
    | サブネット アドレス範囲 | **10.8.0.0/24** |

1. 「**仮想ネットワークを作成する**」 ブレードの 「**IP アドレス**」 タブに戻り、「**Review + create**」 を選択します。

1. 「**仮想ネットワークを作成する**」 ブレードの 「**Review + create**」 タブで、「**作成する**」 を選択します。

1. Azure portal で、**仮想ネットワーク**を検索して選択し、「**仮想ネットワーク**」 ブレードで、「**+ 新規**」 を選択します。

1. 「**仮想ネットワークの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定し (他は既定値のままにします)、「**次へ: IP アドレス**:

    | 設定 | 値 |
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az30308c-labRG** |
    | 名前 | **az30308c-test-vnet** |
    | リージョン | このラボの前半で仮想マシンにデプロイした Azure リージョンの名前 |

1. 「**仮想ネットワークを作成する**」 ブレードの 「**IP アドレス**」 タブで、「**IPv4 アドレス空間**」 テキスト ボックスに「**10.8.0.0/16**」と入力し、「**+ サブネットを追加**」 を選択します。

1. **サブネットを追加** ブレードで次の設定を指定（他の設定はデフォルト値のままにします）し、 **追加**を選択します：

    | 設定 | 値 |
    | --- | --- |
    | サブネット名 | **subnet0** |
    | サブネット アドレス範囲 | **10.8.0.0/24** |

1. 「**仮想ネットワークを作成する**」 ブレードの 「**IP アドレス**」 タブに戻り、「**Review + create**」 を選択します。

1. 「**仮想ネットワークを作成する**」 ブレードの 「**Review + create**」 タブで、「**作成する**」 を選択します。

1. Azure portalで、「**ストレージ アカウント**」 を検索して選択し、「**ストレージ アカウント**」 ブレードで、「**+ 新規**」 を選択します。

1. 「**ストレージ アカウントの作成**」 ブレードの 「**基本**」 タブで 、次の設定を指定します (他の設定は既定値のままにします)。

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az30308c-labRG** |
    | ストレージ アカウント名 | 文字と数字で構成される、長さ 3 文字から 24 文字までのグローバルに一意な名前 |
    | 場所 | このタスクの前半で仮想ネットワークを作成した Azure リージョンの名前 |
    | パフォーマンス | **Standard** |
    | アカウントの種類 | **StorageV2 (汎用 v2)** |
    | レプリケーション | **ローカル冗長ストレージ (LRS)** |

1. 「**ストレージ アカウントを作成する**」 ブレードの 「**基本**」 タブで、「**Review + create**」 を選択します。

1. 「**ストレージ アカウントを作成する**」 ブレードの 「**Review + create**」 タブで、「**作成**」 を選択します。


### 演習 2: Azure Migrate を使用して移行のために Hyper-V を評価する
  
この演習の主なタスクは次のとおりです。

1. Azure Migrate アプライアンスをデプロイし、構成する

1. 評価の構成、実行、および表示


#### タスク 1: Azure Migrate アプライアンスをデプロイし、構成する

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、Azure portal の Microsoft Edge ウィンドウで「**Azure Migrate**」を検索して選択します。

1. **Azure Migrate | サーバー** ブレードの 「**Azure Migrate:** **Discovery and assessment**」 タイルで、**「検出」** を選択します。 

1. 「**マシンの発見**」 ブレードの 「**お使いのサーバーは仮想化されていますか?**」 ドロップダウン リストで、「**はい、 Hyper-V を使用します**」 を選択します。 

1. 「**マシンの発見**」 ブレードの 「**アプライアンスに名前を指定する**」 テキスト ボックスで「**az30308a-vma1**」と入力し、「**キーの生成**」 を選択します。

   > **注**: Azure Migrate プロジェクト キーの生成中にアクセス許可に関連するエラーが発生した場合は、Azure ｐortal で 「**サブスクリプション**」 ブレードに移動し、お使いになっているサブスクリプションを選択します。そのサブスクリプション ブレードで 「**アクセス制御 (IAM)**」 を選択し、Azure AD ユーザー アカウントに**所有者**の役割を割り当てます。

1. リソースのプロビジョニングが完了するのを待ちます。**az30308a-hv-vm** へのリモート デスクトップ セッションでメモ帳を起動し、**Azure Migrate プロジェクト キー**をメモ帳にコピーします。 

1. 「**マシンの発見**」 ブレードの 「**Azure Migrate アプライアンスのダウンロード**」 テキスト ボックスで、「**VHD ファイル**」 オプションを選択し、「**ダウンロード**」 を選択します。プロンプトが表示されたら、ダウンロードの場所を **F:\VMs** フォルダーに設定します。

   > **注**: ダウンロードが完了するまで待ってください。5 分間程度かかる場合があります。

1. ダウンロードが完了したら、ダウンロードした .ZIP ファイルのコンテンツを **F:\VMs** フォルダーに抽出します。 

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、**Hyper-V マネージャー** コンソールに切り替え、**az30308a-hv-vm** ノードを選択し、「**仮想マシンのインポート**」 を選択します。これにより、**仮想マシンのインポート** ウィザードが起動します。

1. **仮想マシンのインポート** ウィザードの 「**開始する前に**」 ページで、「**次へ >**」 をクリックします。

1. **仮想マシンのインポート** ウィザードの **「フォルダーの検索」** ページで、抽出した**仮想マシン** フォルダーの場所を指定し、**「次へ >」** を選択します。

1. **仮想マシンのインポート** ウィザードの 「**仮想マシンを選択**」 ページで、「**次へ >**」 を選択します:

1. **仮想マシンのインポート** ウィザードの 「**インポート タイプを選択**」 ページで、「**仮想マシンを所定の場所に登録する (既存の一意の ID を使用する)**」 を選択し、「**次へ >**」を選択します。

1. **仮想マシンのインポート** ウィザードの**プロセッサーの構成**ページで、**仮想プロセッサーの数**を **4** に設定し、「**次へ >**」 を選択します。

   > **注**: 仮想プロセッサの数の変更に関するエラー メッセージは無視してください。 

1. **仮想マシンのインポート** ウィザードの、**ネットワークに接続**ページの**接続**ドロップダウン リストで **NestedSwitch** を選択し、「**次へ >**」 を選択します。

1. **仮想マシンのインポート** ウィザードの**概要**ページで、「**仕上げ**」 を選択します。

   > **注**: インポートが完了するまで待ちます。10 分間程度かかる場合があります。

1. **Hyper-V マネージャー** コンソールで、新しくインポートした仮想マシンを選択し、「**名前を変更**」 を選択して、名前を **az30308a-vma1** に設定します。

1. **Hyper-V マネージャー** コンソールの中で、新しくインポートした仮想マシンを選択し、 **開始**を選択します。 

1. **Hyper-V マネージャー** コンソールで、仮想マシンが実行されていることを確認し、「**接続**」 を選択します。 

1. 仮想アプライアンスへの仮想マシン接続ウィンドウで、**ライセンス条項** ページで、**承諾する**を選択します。 

1. 仮想アプライアンスへの仮想マシン接続ウィンドウで、**設定のカスタマイズ** ページで、ビルトイン管理者アカウントのパスワードを **Pa55w.rd1234** に設定し、 **仕上げ**を選択します。 

1. 仮想アプライアンスへの 「仮想マシン接続」 ウィンドウで、新しく設定したパスワードを使用してサインインします。

1. 仮想アプライアンスへの仮想マシン接続ウィンドウ内で、Windows PowerShell を起動し、以下を実行して IP アドレスを特定します。

   ```powershell
   (Get-NetIPAddress).IPAddress
   ```

1. 「**az30308a-hv-vm**」 へのリモート デスクトップ セッション内で、既定の設定を使って Microsoft Edge をダウンロードしてインストールします。

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、Microsoft Edge ウィンドウを起動し、[https://`IPaddress`:44368](https://`IPaddress`:44368) に移動します。ここで、` Ipaddress` プレースホルダーは、前のステップで識別した IP アドレスを表します。

   >**注**: Web サイトのセキュリティ証明書に関する警告は無視してください。 

1. プロンプトが表示されたら、次の認証情報を入力します。

    | 設定 | 値 | 
    | --- | --- |
    | 「ユーザー名」 | **administrator** |
    | パスワード | **Pa55w.rd1234** |

1. Microsoft Edge ウィンドウの 「**アプライアンス構成マネージャー**」 ページで 「**同意する**」 ボタンを選択し、前提条件が検証されるまで待ってから、「**続行**」 を選択します。 

1. Microsoft Edge ウィンドウの 「**アプライアンス構成マネージャー**」 ページの 「**Azure Migrate に登録**」 セクションの 「**Azure Migrate プロジェクト キーを提供する**」 テキスト ボックスで、この演習の前半でメモ帳にコピーしたキーを貼り付け、「**ログイン**」 を選択します。表示されたデフォルトのコードを受け入れてクリップボードにコピーし、「**コードをコピーしてログイン**」 を選択し、ブラウザー ページの 「**コードの入力**」 ペインでクリップボードにコピーしたコードを貼り付けて 「**次へ**」 を選択し、このラボで使用しているサブスクリプションで所有者の役割を持つユーザー アカウントの資格情報を提供してサインインし、ブラウザー ページを閉じます。 

1. Microsoft Edge ウィンドウ内の 「**アプライアンス構成マネージャー**」 ページで、登録が成功したことを確認し、「**継続**」 を選択します。 

1. Microsoft Edge ウィンドウの 「**アプライアンス構成マネージャー** 」 ページの 「**認証情報と検出ソースの管理**」 セクションで、「**認証情報の追加**」 を選択します。「**認証情報の追加**」 ウィンドウで、次の設定を指定して 「**保存**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | フレンドリ名 | **az30308acreds** |    
    | 「ユーザー名」 | **Student** |
    | パスワード | **Pa55w.rd1234** |

1. Microsoft Edge ウィンドウ内で、「**アプライアンス構成マネージャー**」 ページの 「**Hyper-V ホスト/クラスターの詳細**」 セクションで 「**検出ソースの追加**」 を選択します。「**検出ソースの追加**」 ペインで 「**単一のアイテムを追加**」 オプションを選択し、「**検出ソース**」 ドロップダウン リストが 「**Hyper-V ホスト/クラスター**」 に設定されていることを確認します。「**フレンドリ名**」 ドロップダウン リストで 「**az30308acreds**」 エントリを選択します。「**IP アドレス/FQDN**」 テキスト ボックスで「**10.0.2.1**」と入力し、「**保存**」 を選択します。 

1. Microsoft Edge ウィンドウ内で、「**アプライアンス構成マネージャー**」 ページの 「**Hyper-V ホスト/クラスターの詳細を提供**」 セクションで、「**検出の開始**」 を選択します。 

   >**注**: 一般に、検出されたサーバーのメタデータが Azure portal に表示されるまで、ホストごとに約 15 分かかる場合があります。


#### タスク 2: 評価の構成、実行、および表示

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、 Azure portal を表示している Microsoft Edge ウィンドウで、「**Azure Migrate** | **サーバー**」 ブレードで 「**最新の情報に更新**」 を選択し、「**Azure Migrate: Discovery and Assessment**」 タイルで、「**評価 | Azure VM**」 を選択します。

   >**注**: 場合によっては、ページを更新する必要があります。 

1. 「**評価プロパティ**」 ブレードで、「**編集**」 を選択し、次の設定を指定し (他は既定値のままにします)、「**作成**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | ターゲットの場所 | このラボのために使用する Azure リージョン名 |
    | ストレージの種類 | **自動** |
    | 予約インスタンス | **予約インスタンスがありません** |
    | サイズ変更の設定基準 | **オンプレミスとして** |
    | VM シリーズ | **Dsv3_series** |
    | 快適性係数 | **1** |
    | プラン | **従量課金制** |
    | Currency | 米ドル ($) | 
    | 割引 | **0** |
    | VM のアップタイム | 1 か月あたり **31** 日、1 日あたり **24** 時間| 

   >**注**: ラボ環境に固有の限られた時間を考慮すると、この場合の唯一の実行可能なオプションは、**オンプレミスとして** の評価です。 

1. 「**サーバーの評価**」 ブレードに戻り、「**次へ**」 を選択してから、「**評価するサーバーの選択**」 タブにナビゲートします。

1. **評価名**を **az30308a-assessment** に設定します。

1. 「**新規作成**」 オプションが選択されていることを確認し、グループ名を「**az30308a-assessment-group**」に設定します。グループに追加するマシンのリストで 「**az30308a-vm1**」 を選択します。

1. 「**次へ**」 をクリックしてから、「**評価の作成**」 をクリックします。 

1. 「**Azure Migrate | サーバー**」 ブレードに戻り、「**更新**」 を選択します。「**Azure Migrate: サーバーの評価**」 タイルで、「**評価**」 行に「**1**」のエントリが含まれていることを確認してから、それを選択します。

1. 「**Azure Migrate: Server Assessment**」 | 「**評価**」 ブレードで、新しく作成された評価 **az30308a-assessment** を選択します。 

1. 「**az30308a-assessment**」 ブレードで、コンピューティングとストレージの両方に対する Azure 対応性と毎月のコストの見積もりを示す情報を確認します。 

   >**注**: 実際のシナリオでは、依存関係エージェントのインストールを検討して、評価段階でサーバーの依存関係を詳しく分析する必要があります。


### 演習 3: Azure Migrate を使用して Hyper-V VM を移行する
  
この演習の主なタスクは次のとおりです。

1. Hyper-V VM の移行の準備

1. Hyper-V VM のレプリケーションを構成する

1. Hyper-V VM の移行を実行する

1. ラボにデプロイした Azure リソースを削除する


#### タスク 1: Hyper-V VM の移行の準備

1. **az30308a-hv-vm** へのリモート デスクトップ セッション内で、 Azure portal を表示している Microsoft Edge ウィンドウで、「**Azure Migrate | サーバー**」 ブレードに戻ります。 

1. 「**Azure Migrate | サーバー**」 ブレードの 「**Azure Migrate: Server Migration**」 タイルで、「**検出**」 リンクを選択します。 

1. 「**マシンの検出**」 ブレードで、次の設定を指定し (他の設定は既定値のままにします)、「**リソースの作成**」 を選択します。

    | 設定 | 値 | 
    | --- | --- |
    | マシンは仮想化しますか?  | **はい、Hyper-V を使用します** |
    | ターゲット リージョン | このラボのために使用する Azure リージョン名 | 
    | 移行先のターゲット リージョンを確認する | 選択済み |

    > **注**: この手順により、Azure Site Recovery コンテナーのプロビジョニングが自動的にトリガーされます。

1. 「**マシンの検出**」 ブレードの 「**1. Hyper-V ホスト サーバーを準備する**」 ステップで、最初の**ダウンロード** リンク (ダウンロード ボタンではありません) を選択し、Hyper-V レプリケーション プロバイダー ソフトウェア インストーラーをダウンロードします。

1. プロンプトが表示されたら、「**AzureSiteRecoveryProvider.exe**」 を起動します。**Azure Site Recovery Provider のセットアップ (Hyper-V サーバー)** ウィザードが開始されます。

1. **Microsoft Update** ページで、「**オフ**」、「**次へ**」 を選択します。

1. 「**プロバイダーのインストール**」 ページで、「**インストール**」 を選択します。

1. Azure portal に切り替え、「**マシンの検出**」 ブレードで、コンテナー登録キーをダウンロードするため、オンプレミスの Hyper-V ホストを準備するためのステップ 1 で**ダウンロード** ボタンを選択します。プロンプトが表示されたら、登録キーを 「**ダウンロード**」 フォルダーに保存します。

1. 「**プロバイダーのインストール**」 ページに切り替えて、「**登録**」 を選択します。これにより、**Microsoft Azure Site Recovery 登録ウィザード**が起動します。

1. 「**Microsoft Azure Site Recovery の登録ウィザード**」 の 「**Vault 設定**」 のページで、「**参照する**」 を選択して 「**ダウンロード**」 フォルダーを表示し、Vault 認証情報ファイルを選択して 「**開く**」 を選択します。

1. **Microsoft Azure Site Recovery 登録ウィザード**の**コンテナ―の設定**ページに戻り、「**次へ**」 を選択します。

1. **Microsoft Azure Site Recovery 登録ウィザード**の**プロキシ設定**ページで、既定の設定を受け入れ、「**次へ**」 を選択します。

1. **Microsoft Azure Site Recovery 登録ウィザード**の **登録**ページで、**仕上げ**を選択します。

1. 登録プロセスが完了したら、「**マシンの検出**」 ブレードで 「**登録の最終処理**」 を選択します。

   >**注**: 「**マシンの検出**」 ブレードを表示しているブラウザーのページを更新して、そこに戻る必要があるかもしれません。

   >**注**: 仮想マシンの検出が完了するまでに最大 15 分かかる場合があります。


#### タスク 2: Hyper-V VM のレプリケーションを構成する

1. 登録完了の確認を受信したら、「**Azure Migrate | サーバー**」 ブレードの 「**Azure Migrate: Server Migration**」 タイルで、「**レプリケート**」 リンクを選択します。 

   >**注**: 「**Azure Migrate | サーバー**」 ブレードを表示するブラウザー ページを更新する必要がある場合があります。

1. 「**レプリケート**」 ブレードの 「**ソース設定**」 ページの 「**マシンは仮想化されていますか?**」 ドロップダウン リストで、「**はい、 Hyper-V を使用します**」 を選択し、「**次へ: 仮想マシン**」 をクリックします。  

1. 「**レプリケート**」 ブレードの 「**仮想マシン**」 ページで、次の設定を指定し (他の設定はデフォルト値のままにします)、「**次へ:**」 を選択します**次: ターゲット設定**:

    | 設定 | 値 | 
    | --- | --- |
    | Azure Migrate 評価から移行設定をインポートする | **はい、Azure Migrate 評価から移行設定を適用** |
    | グループの選択 | **az30308a-assessment-group** |
    | 評価の選択 | **az30308a-assessment** |
    | 仮想マシン | **az30308a-vm1** |

1. 「**レプリケート**」 ブレードの 「**ターゲット設定**」 ページで、次の設定を指定し (他の設定はデフォルト値のままにします)、「**次へ:**」 を選択します**コンピューティング**:

    | 設定 | 値 | 
    | --- | --- |
    | 定期売買 | このラボで使用する Azure サブスクリプションの名前 |
    | リソース グループ | **az30308c-labRG** |
    | レプリケーション ストレージ アカウント | このラボで前に作成したストレージ アカウントの名前 | 
    | 仮想ネットワーク | **az30308c-migration-vnet** |
    | サブネット | **subnet0** |

1. 「**レプリケート**」 ブレードの 「**コンピューティング**」 ページで、「**Azure VM サイズ**」 ドロップダウン リスト内で 「**Standard_D2s_v3**」 が選択されていることを確認します。「**OS タイプ**」 ドロップダウン リストで 「**Windows**」 を選択し、「**次へ: ディスク**」 を選択します。  

1. 「**レプリケート**」 ブレードの 「**ディスク**」 ページで、デフォルト設定を受け入れ、「**次へ: レビュー + レプリケーションの開始**」 を選択します。  

1. 「**レプリケート**」 ブレードの 「**レビュー + レプリケーションの開始**」 ページで、「**レプリケート**」 を選択します。  

1. レプリケーションのステータスを監視するには、「**Azure Migrate | サーバー**」 ブレードの 「**Azure Migrate: Server Migration**」 タイルで 「**サーバーをレプリケートしています**」 エントリを選択します。「**Azure Migrate: Server Migration | マシンのレプリケート**」 で、レプリケート中のマシンのリストの 「**状態**」 列を調べます。

1. ステータスが 「**保護**」 に変わるまで待ちます。これはおよそ 15 分間かかるかもしれません。


#### タスク 3: Hyper-V VM の移行を実行する

1. Azure portal の 「**Azure Migrate: Server Migration | マシンのレプリケート**」 で、**az30308a-vm1** 仮想マシンを表すエントリを選択します。

1. **az30308a-vm1** 仮想マシンのレプリケート ブレードで、「**移行テスト**」 を選択します。

1. 「**移行テスト**」 ブレードの 「**仮想ネットワーク**」 ドロップダウン リストで、「**az30308c-test-vnet**」 および 「**移行テスト**」 を選択します。

   >**注**: テスト移行が完了するまで待ちます。5 分間程度かかる場合があります。

1. Azure portal で、**仮想マシン**を検索して選択し、「**仮想マシン**」 ブレードで、新しくプロビジョニングされた仮想マシン **az30308a-vm1-test** を表すエントリを確認します。

1. Azure portal で、「**Azure Migrate: Server Migration | マシンのレプリケート**」 に戻り、「**更新**」 を選択し、**az30308a-vm1** 仮想マシンが「**クリーンアップ テストのフェールオーバーが保留中**」状態でリストされていることを確認します。

1. 「**Azure Migrate: Server Migration | マシンのレプリケート**」 ブレードで、**az30308a-vm1** 仮想マシンを表すエントリを選択します。

1. **az30308a-vm1** マシンのレプリケート」 ブレードで、「**テスト移行をクリーンアップする**」 を選択します。

1. 「**テスト移行のクリーンアップ**」 ブレードで、「**テストが完了しました**」 チェックボックスを選択します。**テスト仮想マシンを削除**して、「**テストのクリーンアップ**」 を選択します。

1. テスト フェールオーバー クリーンアップ ジョブが完了したら、**az30308a-vm1** マシンのレプリケート ブレードを表示するブラウザー ページを更新して、ツールバーの**移行**アイコンが自動的に利用可能になったことを確認します。

1. **az30308a-vm1** マシンのレプリケート ブレードで、「**移行**」  リンクを選択します。 

1. 「**移行**」 ブレードの、「**データの損失を最小限に抑えるため、移行前にマシンをシャットダウンしますか?**」 ドロップダウン リストで、「**はい**」 を選択してから、「**az30308a-vm1**」 エントリの横にあるチェックボックスを選択した後、「**移行**」 を選択します。

1. 移行のステータスを監視するには、「**Azure Migrate | サーバー**」 ブレードの 「**Azure Migrate: サーバーの移行**」 タイルで 「**サーバーのレプリケート**」 エントリを選択します。「**Azure Migrate: Server Migration | マシンのレプリケート**」 で、レプリケート中のマシンのリストの 「**ステータス**」 列を調べます。ステータスが「**予定されていたフェールオーバーが終了しました**」になっていることを確認します。

   >**注**: 移行は不可逆的なアクションであると想定されています。完成した情報を確認する場合は、Azure Migrate | サーバー ブレードに戻り、ページを更新し、Azure で移行されたサーバーが移行することを確認します。サーバー移行タイルの値は 1 です。


#### タスク 4: ラボにデプロイした Azure リソースを削除する

1. **az30308a-vm0** へのリモート デスクトップ セッション内の Azure portal を表示しているブラウザーの画面で、Cloud Shell ペイン内で PowerShell セッションを起動します。

1. 「Cloud Shell」 ウィンドウから次のコマンドを実行して、この演習で作成したリソース グループを一覧表示します。

   ```powershell
   Get-AzResourceGroup -Name 'az30308*'
   ```

   > **注**: このラボで作成したリソース グループのみが出力に含まれていることを確認します。このグループは、このタスクで削除されます。

1. 「Cloud Shell」 ウィンドウから次を実行して、このラボで作成したリソース グループを削除します

   ```powershell
   Get-AzResourceGroup -Name 'az30308*' | Remove-AzResourceGroup -Force -AsJob
   ```

1. 「Cloud Shell」 ペインを閉じます。
